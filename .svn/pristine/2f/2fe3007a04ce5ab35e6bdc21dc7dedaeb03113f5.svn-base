<?php
namespace Home\Controller;
use Think\Controller;
class AlipayContractController extends Controller {
    var $alipay_config = array();

    public function __construct(){
        if ( is_weixin() ) {
            die ("点击右上角打开外部链接");
        } 
        parent::__construct();
        $this->alipay_config['partner'] = '2088421636193269';
        $this->alipay_config['seller_id'] = '2088421636193269';
        $this->alipay_config['key'] = 'xa8l7wy0z7gso8jxx3ti5wfbkj5k8i40';
        $this->alipay_config['notify_url'] = "http://".$_SERVER['HTTP_HOST'].U("Home/AlipayContract/notify_url");
        $this->alipay_config['return_url'] = "http://".$_SERVER['HTTP_HOST'].U("Home/AlipayContract/return_url");
        $this->alipay_config['sign_type'] = strtoupper('MD5');
        $this->alipay_config['input_charset'] = strtolower('utf-8');
        $this->alipay_config['cacert'] = getcwd().'\\cacert.pem';
        $this->alipay_config['transport'] = 'http';
        $this->alipay_config['payment_type'] = '1';
        $this->alipay_config['service'] = 'alipay.wap.create.direct.pay.by.user';
    }

    public function pay(){
        import("Vendor.Alipay.lib.alipay_submit");

        /**************************请求参数**************************/

        //商户订单号，商户网站订单系统中唯一订单号，必填
        $out_trade_no = I("WIDout_trade_no");

        //订单名称，必填
        $subject = I("WIDsubject");

        //付款金额，必填
        $total_fee = I("WIDtotal_fee");

        //收银台页面上，商品展示的超链接，必填
        /*$show_url = I("WIDshow_url");*/
        $show_url = "http://".$_SERVER['HTTP_HOST'];

        //商品描述，可空
        $body = I("WIDbody");

        /************************************************************/

        //构造要请求的参数数组，无需改动
        $parameter = array(
                "service"       => $this->alipay_config['service'],
                "partner"       => $this->alipay_config['partner'],
                "seller_id"  => $this->alipay_config['seller_id'],
                "payment_type"  => $this->alipay_config['payment_type'],
                "notify_url"    => $this->alipay_config['notify_url'],
                "return_url"    => $this->alipay_config['return_url'],
                "_input_charset"    => trim(strtolower($this->alipay_config['input_charset'])),
                "out_trade_no"  => $out_trade_no,
                "subject"   => $subject,
                "total_fee" => $total_fee,
                "show_url"  => $show_url,
                //"app_pay"   => "Y",//启用此参数能唤起钱包APP支付宝
                "body"  => $body,
                //其他业务参数根据在线开发文档，添加参数.文档地址:https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.2Z6TSk&treeId=60&articleId=103693&docType=1
                //如"参数名"    => "参数值"   注：上一个参数末尾需要“,”逗号。
                
        );

        //建立请求
        $alipaySubmit = new \AlipaySubmit($this->alipay_config);
        $html_text = $alipaySubmit->buildRequestForm($parameter,"post", "确认");
        echo $html_text;
    }

    /**
    *  [同步]
    **/
    public function return_url(){
        import("Vendor.Alipay.lib.alipay_notify");
        //计算得出通知验证结果
        $alipayNotify = new \AlipayNotify($this->alipay_config);
        $verify_result = $alipayNotify->verifyReturn();
        if($verify_result) {
            $out_trade_no = $_GET['out_trade_no'];//商户订单号
            $trade_no = $_GET['trade_no'];//支付宝交易号         
            $trade_status = $_GET['trade_status'];//交易状态

            if($_GET['trade_status'] == 'TRADE_FINISHED' || $_GET['trade_status'] == 'TRADE_SUCCESS') {
                
                //修改房屋信息
                $MContract = M("contract");
                $account_id = $MContract->where(array("order_no"=>$out_trade_no))->getField("account_id");
                $room_id = $MContract->where(array("order_no"=>$out_trade_no))->getField("room_id");
                $save['pay_status'] = 1;
                $data['pay_type'] = 1;//支付宝
                $save['trade_no'] = $trade_no;
                $save['pay_date'] = date("Y-m-d H:i:s",time());
                $DRoom = D("room");
                $DRoom->setRoomStatus($room_id,2);
                $DRoom->setRoomPerson($room_id,$account_id);

                M("contract")->where(array("order_no"=>$out_trade_no))->save($save);
                $this->success("支付成功!",U("Home/Tenant/index"));
            }
            else {
              echo "trade_status=".$_GET['trade_status'];
            }
        }
        else {
            //验证失败
            //如要调试，请看alipay_notify.php页面的verifyReturn函数
            $this->success("验证失败!",U("Home/Tenant/index"));
        }
    }

    /**
    * [异步]
    **/
    public function notify_url(){
        import("Vendor.Alipay.lib.alipay_notify");
        //计算得出通知验证结果
        $alipayNotify = new \AlipayNotify($this->alipay_config);
        $verify_result = $alipayNotify->verifyNotify();
        if($verify_result) {//验证成功
            $out_trade_no = $_POST['out_trade_no'];//商户订单号
            $trade_no = $_POST['trade_no'];//支付宝交易号
            $trade_status = $_POST['trade_status'];//交易状态
            if($_POST['trade_status'] == 'TRADE_FINISHED') {
                //判断该笔订单是否在商户网站中已经做过处理
                    //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
                    //请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的
                    //如果有做过处理，不执行商户的业务程序
                /*$charge_bill = $MCharge_bill->where(array("id"=>$out_trade_no))->find();*/
                //修改房屋信息
                $MContract = M("contract");
                $account_id = $MContract->where(array("order_no"=>$out_trade_no))->getField("account_id");
                $room_id = $MContract->where(array("order_no"=>$out_trade_no))->getField("room_id");
                $save['pay_status'] = 1;
                $data['pay_type'] = 1;//支付宝
                $save['trade_no'] = $trade_no;
                $save['pay_date'] = date("Y-m-d H:i:s",time());
                $DRoom = D("room");
                $DRoom->setRoomStatus($room_id,2);
                $DRoom->setRoomPerson($room_id,$account_id);
                
                M("contract")->where(array("order_no"=>$out_trade_no))->save($save);
                //注意：
                //退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知

                logResult("时间:".date("Y-m-d H:i:s",time()).",订单号:".$out_trade_no.",支付宝交易号:".$trade_no.",交易状态:".$trade_status);
                
            }
            else if ($_POST['trade_status'] == 'TRADE_SUCCESS') {
                //判断该笔订单是否在商户网站中已经做过处理
                    //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
                    //请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的
                    //如果有做过处理，不执行商户的业务程序
                $save['pay_status'] = 1;
                $save['trade_no'] = $trade_no;
                $save['pay_time'] = date("Y-m-d H:i:s",time());
                M("charge_bill")->where(array("order_no"=>$out_trade_no))->save($save);
                //注意：
                //付款完成后，支付宝系统发送该交易状态通知

                //调试用，写文本函数记录程序运行情况是否正常
                logResult("时间:".date("Y-m-d H:i:s",time()).",订单号:".$out_trade_no.",支付宝交易号:".$trade_no.",交易状态:".$trade_status);
            }

            //——请根据您的业务逻辑来编写程序（以上代码仅作参考）——
                
            echo "success";     //请不要修改或删除
            
            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        }
        else {
            //验证失败
            echo "fail";

            //调试用，写文本函数记录程序运行情况是否正常
            //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
        }
    }
}
