<?php
namespace Admin\Controller;
use Think\Controller;
class PayController extends Controller {
    public function __construct(){
        parent::__construct();
        if ( empty($_SESSION['username']) && ACTION_NAME != 'register') {
            header("Location:".U("Admin/Index/login"));
            die();
        }
    }
    /**
    * [合同账单]
    **/
    public function contract_bill(){
        //搜索条件
        $DRoom = D("room");
        $DAccount = D("account");
        $DArea = D("area");
        $DContract = D("contract");

        if ( !empty(I("room_code")) ) {
            $room_id = $DRoom->getRoomIdByCode(I("room_code"));
            $where['room_id'] = $room_id;
        }
        if ( !empty(I("realname")) ) {
            $account_id = $DAccount->getAccountId("realname",I("realname"));
            $where['account_id'] = $account_id;
        }
        if ( !empty(I("area_id")) ) {
            $house_code_str = $DArea->getHouseCodeListByAreaId(I("area_id"));
            $where['house_code'] = array("IN",$house_code_str);
        }
        if ( !empty(I("input_month")) ) {
            $where['input_month'] = I("input_month");
        }
        if ( !empty(I("input_year")) ) {
            $where['input_year'] = I("input_year");
        }
        if ( !empty(I("pay_status")) ) {
            $where['pay_status'] = I("pay_status");
        }
        $order = "id desc,create_time desc";
        if ( !empty(I("sort_type")) ) {
            $sort = I("sort")==1? "asc":"desc";
            switch (I("sort_type")) {
                case 'payType':
                    $order = "pay_type ".$sort;
                    break;
                case 'startDate':
                    $order = "start_time ".$sort;
                    break;
                case 'endDate':
                    $order = "end_time ".$sort;
                    break;
                case 'rentDate':
                    $order = "rent_date ".$sort;
                    break;
                case 'tbq':
                    # code...
                    break;
                case 'inputMonth':
                    $order = "input_year ".$sort.", input_month ".$sort;
                    break;
                case 'payDate':
                    $order = "pay_date ".$sort;
                    break;
                
                default:
                    # code...
                    break;
            }
        }

        $MContract = M("contract");// 实例化User对象
        $DContract = D("contract");

        $where['is_delete'] = 0;

        $count      = $MContract->where($where)->count();// 查询满足要求的总记录数

        $Page       = new \Think\Page($count,10);// 实例化分页类 传入总记录数和每页显示的记录数(25)

        $show       = $Page->show();// 分页显示输出

        $list       = $MContract->where($where)->order($order)->limit($Page->firstRow.','.$Page->listRows)->select();

        $DAccount = D("account");
        $DRoom = D("room");
        foreach ( $list AS $key=>$val ) {
            $list[$key]['realname'] = $DAccount->getFieldById($val['account_id'],"realname");
            $list[$key]['mobile'] = $DAccount->getFieldById($val['account_id'],"mobile");
            $list[$key]['room_info'] = $DRoom->getRoomById($val['room_id']);
            $list[$key]['year'] = date("Y",strtotime($val['start_time']));
            $list[$key]['month'] = date("m",strtotime($val['start_time']));
            $rent_type = explode("_", $val['rent_type']);
            $list[$key]['rent_type_name'] = "押".$rent_type['0']."付".$rent_type['1'];
            $list[$key]['contract_status_name'] = C("contract_status_arr")[$val['contract_status']];
            $list[$key]['pay_type_name'] = C("pay_type")[$val['pay_type']];
        }

        /*$contract_list = $DContract->getContractList();*/
        /*$this->assign("contract_list",$contract_list);*/
        $this->assign('contract_list',$list);// 赋值数据集
        $this->assign('page',$show);// 赋值分页输出
        $this->display("contract-bill");
    }
    /**
    * [日常账单]
    **/
    public function daily_bill(){
        //搜索条件
        $DRoom = D("room");
        $DAccount = D("account");
        $DArea = D("area");
        $DContract = D("contract");

        if ( !empty(I("room_code")) ) {
            $room_id = $DRoom->getRoomIdByCode(I("room_code"));
            $where['room_id'] = $room_id;
        }
        if ( !empty(I("area_id")) ) {
            $house_code_str = $DArea->getHouseCodeListByAreaId(I("area_id"));
            $where['house_code'] = array("IN",$house_code_str);
        }
        if ( !empty(I("input_month")) ) {
            $where['input_month'] = I("input_month");
        }
        if ( !empty(I("input_year")) ) {
            $where['input_year'] = I("input_year");
        }
        if ( !empty(I("pay_status")) ) {
            $where['pay_status'] = I("pay_status");
        }

        $where['is_delete'] = 0;
    	$MChargeBill = M("charge_bill");// 实例化User对象

    	/*$charge_bill_list = $DChargeBill->showDailyBillList();*/

        $count      = $MChargeBill->where($where)->count();// 查询满足要求的总记录数

        $Page       = new \Think\Page($count,10);// 实例化分页类 传入总记录数和每页显示的记录数(25)

        $show       = $Page->show();// 分页显示输出

        $list       = $MChargeBill->where($where)->order("id desc,create_time desc")->limit($Page->firstRow.','.$Page->listRows)->select();

        
        foreach ($list AS $key=>$val) {
            $list[$key]['room_code'] = $DRoom->getRoomCodeById($val['room_id']);
            $list[$key]['bed_code'] = $DRoom->getBedCodeById($val['room_id']);
            $list[$key]['realname'] = $DAccount->getFieldById($val['account_id'],"realname");
            $list[$key]['mobile'] = $DAccount->getFieldById($val['account_id'],"mobile");
            $list[$key]['SDQtotal'] = $val['water_fee'] + $val['gas_fee'] + $val['energy_fee'] + $val['room_energy_fee'];
            $list[$key]['area_name'] = $DArea->getAreaInfoByCode($val['house_code']);
            $list[$key]['ht_start_date'] = $DContract->getContractStartDate($val['account_id'],$val['room_id']);
            $list[$key]['ht_end_date'] = $DContract->getContractEndDate($val['account_id'],$val['room_id']);
            $list[$key]['period'] = $DContract->getPeriod($val['account_id'],$val['room_id']);
            $list[$key]['deposit'] = $DContract->getDeposit($val['account_id'],$val['room_id']);
            $pay_type = C("pay_type");
            $list[$key]['pay_type_name'] = $pay_type[$val['pay_type']];
            //最迟缴费倒计时
            $startdate=strtotime($val['should_pay_date']);
            $enddate=strtotime(date("Y-m-d",time()));
            $count_down_days=round(($startdate-$enddate)/86400);
            $list[$key]['count_down_days'] = $count_down_days;
            switch ($val['type']) {
                case 1:
                    $list[$key]['type_name'] = "日常";
                    break;
                case 2:
                    $list[$key]['type_name'] = "退房";
                    break;
                case 3:
                    $list[$key]['type_name'] = "转房";
                    break;
                case 4:
                    $list[$key]['type_name'] = "换房";
                    break;
            }
        }

        $this->assign('charge_bill_list',$list);// 赋值数据集
        $this->assign('page',$show);// 赋值分页输出

        //小区列表
        $DArea = D("area");
        $this->assign('area_list',$DArea->getareaList());
    	/*$this->assign("charge_bill_list",$charge_bill_list);*/
    	$this->display("daily-bill");
    }

    /**
    * [修改账单支付状态]
    **/
    public function edit_pay(){
    	if ( !empty($_POST) ) {
    		$id = I('id');
    		$data['pay_type'] = I("pay_type");
    		$data['pay_time'] = I("pay_time");
    		$data['pay_money'] = I("pay_money");
    		$data['pay_log'] = I("pay_log");
    		$data['pay_status'] = 1;
    		$result = M("charge_bill")->where(array("id"=>$id))->save($data);
    		if ( !empty($result) ) {
    			$this->success("修改成功",U("Admin/Pay/daily_bill"));
    		} else {
    			$this->error("修改失败",U("Admin/Pay/daily_bill"));
    		}
    		
    	} else {
    		$id = I("id");
            $DChargeBill = D("charge_bill");
            $pay_info = $DChargeBill->getPayInfo($id);
            $this->assign("pay_info",$pay_info);
    		$this->assign("id",$id);
    		$this->assign("pay_type",C("pay_type"));
    		$this->display("edit-pay");
    	}	
    }
    
    /**
    * [修改合同账单]
    **/
    public function edit_contract_pay(){
        if ( !empty($_POST) ) {
            $id = I('id');
            $MContract = M("contract");
            $account_id = $MContract->where(array("id"=>$id))->getField("account_id");
            $room_id = $MContract->where(array("id"=>$id))->getField("room_id");
            $data['pay_type'] = I("pay_type");
            $data['pay_date'] = I("pay_time");
            $data['pay_log'] = I("pay_log");
            $data['pay_status'] = 1;
            $result = $MContract->where(array("id"=>$id))->save($data);

            if ( $result ) {
                $DRoom = D("room");
                $DRoom->setRoomStatus($room_id,2);
                $DRoom->setRoomPerson($room_id,$account_id);
                $this->success("修改成功",U("Admin/Pay/contract_bill"));
            } else {
                $this->error("修改失败",U("Admin/Pay/contract_bill"));
            }
        } else {
            $id = I("id");
            $DChargeBill = D("charge_bill");
            $pay_info = $DChargeBill->getPayInfo($id);
            $this->assign("pay_info",$pay_info);
            $this->assign("id",$id);
            $this->assign("pay_type",C("pay_type"));
            $this->display("edit-contract-pay");
        }
    } 

    public function delete_contract(){
        $id = I("id");
        $result = M("contract")->where(array("id"=>$id))->save(array("is_delete"=>1));
        if ( $result ) {
            $this->success("删除成功!",U("Admin/Pay/contract_bill"));
        } else {
            $this->error("删除失败!",U("Admin/Pay/contract_bill"));
        }
    }

    
    public function delete_bill(){
        $id = I("id");
        $result = M("charge_bill")->where(array("id"=>$id))->save(array("is_delete"=>1));
        if ( $result ) {
            $this->success("删除成功!",U("Admin/Pay/daily_bill"));
        } else {
            $this->error("删除失败!",U("Admin/Pay/daily_bill"));
        }
    }
}