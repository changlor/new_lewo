<?php
namespace Home\Model;
use Think\Model;
/**
* [合同数据层]
*/
class ContractModel extends Model{
	/**
	 * [插入一条新的合同]
	 **/
	public function add($post){
		$MAccount = M("account");
		$account_info = $MAccount->where(array("mobile"=>$post['mobile']))->find();

		if ( !$account_info ) {
			//插入帐号
			$data['realname'] = $post['realName'];
			$data['password'] = md5("123456");
			$data['mobile'] = $post['mobile'];
			$data['contact2'] = $post['contact2'];
			$data['card_no'] = $post['idNo'];
			$data['email'] = $post['email'];
			$data['register_time'] = date("Y-m-d H:i:s",time());

			$id = $MAccount->add($data);
		} else {
			$id = $account_info['id'];
		}

		$cData['account_id'] = $id;
		$cData['room_id'] = $post['room_id'];
		$cData['deposit'] = $post['deposit'];
		$cData['book_deposit']= $post['bookDeposit'];
		$rentType = explode("_",$post['rentType']);
		$depositCount = $rentType['0'];//押几
		$payCount = $rentType['1'];//付几
		$cData['period'] = $payCount;
		$cData['pay_status'] = 1;
		$cData['pay_date'] = date("Y-m-d H:i:s",time());
		$cData['creat_time'] = date("Y-m-d H:i:s",time());
		$cData['steward_id'] = $_SESSION['steward_id'];
		$cData['rent_type'] = $post['rentType'];
		$cData['contract_status'] = C('ht_zc');
		$cData['start_time'] = $post['startDate'];
		$cData['end_time'] = $post['endDate'];
		$cData['rent'] = $post['rent'];
		$cData['fee'] = $post['fee'];
		$cData['contact2'] = $post['contact2'];
		$cData['person_count'] = $post['personCount'];

		$hz_info['hzRealname'] = $post['hzRealname'];
		$hz_info['hzMobile'] = $post['hzMobile'];
		$hz_info['hzCardNo'] = $post['hzCardNo'];

		$cData['cotenant'] = serialize($hz_info);
		$cData['zS'] = $post['zS'];
		$cData['zD'] = $post['zD'];
		$cData['zQ'] = $post['zQ'];
		$cData['roomD'] = $post['roomD'];
		
		$MContract = M("contract");
		
		$result['status'] = $MContract->add($cData);
		$result['account_id'] = $id;
		return $result;
	}

	/**
	* [根据用户id获取最新合同]
	**/
	public function getNewContractById($account_id){
		$where['account_id'] = $account_id;
		$where['contract_status'] = 1;//正常签约
		$order = "id desc";
		$result = $this->where($where)->order($order)->find();
		return $result;
	}
}

?>