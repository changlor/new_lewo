<?php
namespace Admin\Controller;
use Think\Controller;
/**
 * [租客帐号]
 **/
class TenantController extends Controller {
    public function __construct(){
        parent::__construct();
        if ( empty($_SESSION['username']) && ACTION_NAME != 'register') {
            header("Location:".U("Admin/Index/login"));
            die();
        }
    }
    /**
     * [租客列表]
     **/
    public function account(){
        $Mtenant = M('account');
        $account_arr = $Mtenant->field("id,ip,mobile,login_time,register_time")->select();
        $this->assign('account',$account_arr);
    	$this->display("Common/header");
    	$this->display("Common/nav");
    	$this->display("tenant-account");
    	$this->display("Common/footer");
    }
    /**
     * [添加租客帐号]
     **/
    public function add_account(){
        if ( !empty($_POST) ) {
            if ( $_POST['password'] !== $_POST['repassword'] ){
                die("两次密码不相同");
            }
            $Mtenant = M('account');
            $data['password'] = md5(I('post.password'));
            $data['mobile'] = I('post.mobile');
            $data['email'] = I('post.email');
            $data['sex'] = I('post.sex');
            $data['card_no'] = I('post.card_no');
            $data['sex'] = I('post.sex');
            $data['register_time'] = date('Y-m-d H:i:s');
            $data['ip'] = get_client_ip();
            $result = $Mtenant->where(array('mobile'=>$data['mobile']))->find();
            if ( empty($result) ) {
                $Mtenant->add($data);
                $this->success("注册成功",U("Admin/Tenant/account"));
            } else {
                $this->error("注册失败，电话已存在");
            }
        } else {
            $this->display("Common/header");
            $this->display("Common/nav");
            $this->display('add-account');
            $this->display("Common/footer");
        }
    }

    /**
    * [合同]
    **/
    public function contract_info(){
        $account_id = I("account_id");
        $contract_info = M("contract")->where(array("account_id"=>$account_id,"pay_status"=>1))->order("id desc")->find();
        $contract_info['account_info'] = M("account")->where(array("id"=>$account_id))->find();
        $contract_info['room_info'] = M("room")->where(array("id"=>$contract_info['room_id']))->find();
 
        $this->assign("contract_info",$contract_info);
        $this->display("Common/header");
        $this->display("Common/nav");
        $this->display("contract_info");
        $this->display("Common/footer");
    }
}