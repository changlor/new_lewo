<?php
namespace Home\Model;
use Think\Model;
/**
* [合同数据层]
*/
class ContractModel extends Model{
	/**
	 * [插入一条新的合同]
	 **/
	public function add($post){
		$MAccount = M("account");
		$MContract = M("contract");
		$MPay = M("pay");
		$account_info = $MAccount->where(array("mobile"=>$post['mobile']))->find();

		if ( is_null($account_info) ) {
			//插入帐号
			$data['realname'] 		= $post['realName'];
			$data['password'] 		= md5("123456");//默认密码
			$data['mobile'] 		= $post['mobile'];
			$data['contact2'] 		= $post['contact2'];
			$data['card_no'] 		= $post['idNo'];
			$data['email'] 			= $post['email'];
			$data['register_time'] 	= date("Y-m-d H:i:s",time());

			$id = $MAccount->add($data);
		} else {
			$id = $account_info['id'];
			$save = array();
			$save['realname'] 		= $post['realName'];
			$save['mobile'] 		= $post['mobile'];
			$save['contact2'] 		= $post['contact2'];
			$save['card_no'] 		= $post['idNo'];
			$save['email'] 			= $post['email'];

			$MAccount->where(array('id'=>$id))->save($save);
		}
		$result['result'] = true;
		//判断account_id 是否已经存在了一个未支付的合同账单
		$notpay = $MPay->where(array("account_id"=>$id,"pay_status"=>0,'bill_type'=>2))->select();
		if ( count($notpay) > 0 ) {
			$result['result'] 		= false;
			$result['error_msg'] 	= "已存在未支付合同";
			return $result;
		}
		$start_year 			= date("Y",strtotime($cData['start_time']));
		$start_month 			= date("m",strtotime($cData['start_time']));
		
		$cData['pro_id'] 		= $pData['pro_id'] 		= getOrderNo();//账单号可以用作pro_id
		$cData['account_id'] 	= $pData['account_id'] 	= $id;
		$cData['room_id'] 		= $pData['room_id'] 	= $post['room_id'];
		$pData['pay_status'] 	= 0;
		$cData['create_time'] 	= $pData['create_time'] = date("Y-m-d H:i:s",time());
		$pData['bill_type'] 	= 2;
		$pData['input_year'] 	= $start_year;
		$pData['input_month'] 	= $start_month;
		$pData['should_date'] 	= date("Y-m-d",time());
		$pData['last_date'] 	= date("Y-m-d",time());
		$pData['is_send']		= 1;

		$cData['deposit'] 		= $post['deposit'];
		$cData['wg_fee']		= $post['wg_fee'];
		$cData['book_deposit']	= $post['bookDeposit'];
		$rentType 				= explode("_",$post['rentType']);
		$depositCount 			= $rentType['0'];//押几
		$payCount 				= $rentType['1'];//付几
		$cData['period'] 		= $payCount;
		$cData['steward_id'] 	= !empty($_SESSION['steward_id'])?$_SESSION['steward_id']:0;
		$cData['rent_type'] 	= $post['rentType'];
		$cData['start_time'] 	= $post['startDate'];
		$cData['end_time'] 		= $post['endDate'];
		
		$cData['rent_date'] 	= correct_date(date("Y",strtotime($start_year."-".$start_month."+".$cData['period']." month")),date("m",strtotime($start_year."-".$start_month."+".$cData['period']." month")),date("d",strtotime($cData['end_time']))); //房租到期日
		$cData['rent'] 			= $post['rent'];
		$cData['fee'] 			= $post['fee'];
		$cData['contact2'] 		= $post['contact2'];
		$cData['person_count'] 	= $post['personCount'];
		$hz_info['hzRealname'] 	= $post['hzRealname'];
		$hz_info['hzMobile'] 	= $post['hzMobile'];
		$hz_info['hzCardNo'] 	= $post['hzCardNo'];
		$cData['cotenant'] 		= serialize($hz_info);
		$cData['roomD'] 		= $post['roomD'];
		$cData['total_fee'] 	= $post['total'];//总金额
		$cData['photo'] 		= !is_null($post['photo'])?$post['photo']:"";//合影

		//是否使用余额抵扣
		if ( !empty($post['is_deduct']) ) {
			$balance = $MAccount->where(array("id"=>$id))->getField("balance");//余额
			$cData['balance'] = $balance;
					
			if ( $post['paytotal'] > $balance ) {
				$post['paytotal'] = $post['paytotal'] - $balance;
				$change_balance = 0; 
			} else {
				$post['paytotal'] = 0;
				$change_balance = $balance - $post['paytotal'];//如果余额大于应支付金额，应支付0，修改帐号的余额
			}
			$MAccount->where(array("id"=>$id))->save(array("balance"=>$change_balance));
		}

		$cData['pay_total'] = $pData['price'] = $post['paytotal'];//应支付金额

		$MContract->add($cData); //再插入contract表
		$result['id'] = $MPay->add($pData);	//先插入pay表中
		$result['account_id'] = $id;
		return $result;
	}

	/**
	* [根据用户id获取最新合同]
	**/
	public function getNewContractById($account_id){
		$where['account_id'] = $account_id;
		$where['contract_status'] = 1;//正常签约
		$order = "id desc";
		$result = $this->where($where)->order($order)->find();
		return $result;
	}

	/**
	* [获取未支付合同]
	**/
	public function getNotPayContract($account_id){
		$pay_info = M("pay")
				->alias('p')
				->field('c.*,p.*')
				->join("lewo_contract c ON p.pro_id=c.pro_id")
				->where(array("p.account_id"=>$account_id,"p.bill_type"=>C("bill_type_ht"),"p.pay_status"=>0,"is_show"=>1))
				->order("p.id desc")
				->find();

        $MHouses = M("houses");
        $MArea = M("area");
        $MRoom = M("room");
        $MAccount = M("account");
        if ( !is_null($pay_info) ) {
        	$house_code = $MRoom->where(array("id"=>$pay_info['room_id']))->getField("house_code");
        	$realname = $MAccount->where(array('id'=>$account_id))->getField("realname");
	        //根据house_code 判断广州或重庆
	        $area_id = $MHouses->where(array("house_code"=>$house_code))->getField("area_id");
	        $city_id = $MArea->where(array("id"=>$area_id))->getField("city_id");
	        $city_name = C("city_id")[$city_id];
	        $pay_info['bill_info'] = $realname."合同".$city_name."账单";
        } else {
        	return false;
        }

        return $pay_info;
	}
}

?>